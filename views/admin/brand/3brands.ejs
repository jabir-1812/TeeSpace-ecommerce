<div class="container">
  <div class="row my-3">
    <div class="col-6">
      <h3>Brand Management</h3>
    </div>
    <div class="col-6 d-flex justify-content-end">
    <a href="/admin/add-brand"><button class="btn btn-dark">Add New Brand</button></a>
    </div>
  </div>

  <div class="row mb-3">
        <div class="col-xl-6">
            <form action="/admin/brands" method="get">
                <div class="d-flex gap-3 align-items-center">
                    <input type="text" name="search" value="<%= search %>" placeholder="Search brands..." class="form-control">
                    <button type="submit" class="btn btn-dark">Search</button>
                    <a href="/admin/brands" class="btn btn-outline-dark">Clear</a>
                </div>
            </form>
        </div>
    </div>

	<div class="row mb-3">
		<table class="table table-hover">
			<thead class="table-dark">
			<tr>
				<th>Brand</th>
				<th>Logo</th>
				<th>Products</th>
				<th>Offer%</th>
				<th>Offer actions</th>
				<th>Status</th>
				<th>Actions</th>
			</tr>
			</thead>
			<tbody>
			<% if (brands.length> 0){ %>
				<% brands.forEach((brand,index)=>{ %>
				<tr>
					<td><%= brand.brandName %></td>
					<td>
					<img src="<%= brand.brandImage %>" alt="<%= brand.brandName %>" width="40px" />
					</td>
					<td><%= brand.products || 0 %></td>
					<td><%= brand.offer %> %</td>
					<td>
					<% if(brand.offer===0){ %>
						<button class="btn btn-outline-primary" onclick="addOffer('<%= brand._id %>','<%= brand.brandName %>')">Add Offer</button>
						<%}else{%>
						<button class="btn btn-outline-danger" onclick="removeOffer('<%= brand._id %>','<%= brand.brandName %>')">Remove Offer</button>
						<% } %>
					</td>
					<td 
						id="status-<%= index %>" 
						class="<%= brand.isBlocked ? 'text-danger' : 'text-success' %>">
						<%= brand.isBlocked ? 'Blocked' : 'Active' %>
					</td>
					<td>
					<a href="/admin/edit-brand/<%= brand._id %>" class="btn btn-outline-dark">Edit</a>
					<button type="button" 
											class="<%= brand.isBlocked ? 'btn btn-success' : 'btn btn-danger' %>"
											id="brand-<%= brand._id %>"
											data-brand-id="<%= brand._id %>"
											data-is-blocked="<%= brand.isBlocked %>"
											onclick="toggleBlockBrand(this,'<%= index %>')">
										<%= brand.isBlocked ? "Unblock" : "Block" %>        
									</button>
					</td>
				</tr>
				<% }) %>
			<% }else{ %>
				<tr>
				<td colspan="4" class="no-data">No brands found</td>
				</tr>
			<% } %>
			</tbody>
		</table>
	</div>

	<div class="row mb-3">
		<div class="d-flex justify-content-center gap-3">
        <% if (currentPage > 1) { %>
            <a href="/admin/brands?page=<%= currentPage - 1 %>&search=<%= search %>" class="btn btn-light">Previous</a>
        <% } %>

        <% for(let i=1; i <=totalPages; i++) { %>
            <a href="/admin/brands?page=<%= i %>&search=<%= search %>" class="<%= currentPage === i ? 'btn btn-dark' : 'btn btn-outline-dark' %>">
                <%= i %>
            </a>
        <% } %>

        <% if (currentPage < totalPages) { %>
            <a href="/admin/brands?page=<%= currentPage + 1 %>&search=<%= search %>" class="btn btn-light">Next</a>
        <% } %>
        </div>
	</div>
</div>

<script>
// async function addOffer(brandId,brandName) {
//             const {value:percentage}=await Swal.fire({
//                 title:"Offer in percentage",
//                 input:"number",
//                 inputLabel:"Percentage",
//                 inputPlaceholder:"%"
//             });

//             if(percentage){
//                 try {
//                     const response=await fetch('/admin/add-brand-offer',{
//                         method:'POST',
//                         headers:{
//                             'content-type':'application/json'
//                         },
//                         body:JSON.stringify({
//                             percentage:percentage,
//                             brandId:brandId
//                         })
//                     })

//                     const responseJson=await response.json();
//                     if(response.ok && responseJson.status===true){
//                         Swal.fire(
//                             "Offer Added",
//                             "The offer has been added",
//                             "success"
//                         ).then(()=>{
//                            location.reload()
//                         })
//                     }else{
//                         Swal.fire("Failed",responseJson.message || "Adding offer failed","error");
//                     }
//                 } catch (error) {
//                     Swal.fire(
//                         "Error",
//                         "An error occured while adding the offer",
//                         "error"
//                     );

//                     console.log('Error Adding offer:',error)
//                 }
//             }
//         }
async function addOffer(brandId,brandName) {
            const { value: formValues } = await Swal.fire({
                title: `Add Offer to :${brandName}`,
                html: `
                <div style="text-align:left;">
                    <div>
                        <label for="percentage"><b>Offer Percentage (%)</b></label>
                        <input id="percentage" type="number" class="swal2-input" placeholder="e.g. 20" min="1" max="100">
                    </div>

                    <div>
                        <label for="startDate"><b>Start Date</b></label>
                        <input id="startDate" type="date" class="swal2-input" required>
                    </div>

                    <div>
                        <label for="endDate"><b>End Date</b></label>
                        <input id="endDate" type="date" class="swal2-input" required>
                    </div>

                    <div>
                        <label for="description"><b>Description</b></label>
                        <input id="description" type="text" class="swal2-input" placeholder="e.g. Diwali Mega Sale">
                    </div>        
                </div>
                `,
                focusConfirm: false,
                showCancelButton: true,
                confirmButtonText: "Add Offer",
                width: "600px",
                preConfirm: () => {
                const percentage = document.getElementById("percentage").value;
                const startDate = document.getElementById("startDate").value;
                const endDate = document.getElementById("endDate").value;
                const description = document.getElementById("description").value;

                if (!percentage || percentage <= 0 || percentage > 100) {
                    Swal.showValidationMessage("Please enter a valid percentage (1â€“100)");
                    return false;
                }

                if (new Date(endDate) < new Date(startDate)) {
                    Swal.showValidationMessage("End date cannot be earlier than start date");
                    return false;
                }

                return { percentage, startDate, endDate, description };
                }
            });

            if (formValues) {
                try {
                const response = await fetch("/admin/add-brand-offer", {
                    method: "POST",
                    headers: { "content-type": "application/json" },
                    body: JSON.stringify({
                    brandId,
                    percentage: formValues.percentage,
                    startDate: formValues.startDate,
                    endDate: formValues.endDate,
                    description: formValues.description,
                    }),
                });

                const data = await response.json();

                if (response.ok && data.status === true) {
                    Swal.fire({
                    title: "Offer Added",
                    text: "The offer has been added successfully!",
                    icon: "success",
                    timer: 4000,
                    showConfirmButton: true,
                    }).then(() => location.reload());
                } else {
                    Swal.fire("Failed", data.message || "Adding offer failed", "error");
                }
                } catch (error) {
                Swal.fire("Error", "An error occurred while adding the offer", "error");
                console.error("Error Adding offer:", error);
                }
            }
        }



  async function removeOffer(brandId,brandName) {
            try {
                const result =await Swal.fire({
                    title:`Remove offer of : ${brandName}?`,
                    icon:'warning',
                    showCancelButton:true,
                    confirmButtonText:'Yes',
                    cancelButtonText:'Cancel'
                })
                if(result.isConfirmed){
                    const response=await fetch('/admin/remove-brand-offer',{
                        method:"POST",
                        headers:{
                        "content-type":"application/json"
                        },
                        body:JSON.stringify({
                            brandId:brandId
                        })
                    })

                    const responseJson=await response.json();

                    if(response.ok && responseJson.status===true){
                     Swal.fire(
                        "Offer removed",
                        "The offer has been removed",
                        "success"
                        ).then(()=>{
                            location.reload()
                        })
                    }else{
                        Swal.fire("Failed",responseJson.message || "Removing offer failed","error");
                    }
                }
                
            } catch (error) {
                Swal.fire(
                    "Error",
                    "An error occured while removing the offer",
                    "error"
                );
                console.log("Error removing offer:",error)
            }
        }


  async function toggleBlockBrand(button,index) {
    try {
      const brandId=button.dataset.brandId;
      const isBlocked=button.dataset.isBlocked==='true';
      const action=isBlocked ? "Unblock" : "Block";

      if(action==="Block"){
        const result=await Swal.fire({
          title:`Are you sure you want to Block this brand`,
          icon:'warning',
          showCancelButton:true,
          confirmButtonText:'Yes, Block this brand',
          cancelButtonText:'Cancel'
        });

        if(result.isConfirmed){
          const response=await fetch('/admin/block-brand',{
            method:'post',
            headers:{
              'Content-Type':'application/json'
            },
            body:JSON.stringify({brandId})
          });

          const data=await response.json();
          if(data.success){
            Swal.fire({title:data.message,icon:"success",timer:5000,showConfirmButton:true})
            .then(()=>{
              location.reload()
            })
          }else{
            Swal.fire(data.message,"","error")
          }
        }
      }


      if(action==="Unblock"){
        const result=await Swal.fire({
          title:`Are you sure you want to Unblock this brand`,
          icon:'warning',
          showCancelButton:true,
          confirmButtonText:'Yes, Unblock this brand',
          cancelButtonText:'Cancel'
        });

        if(result.isConfirmed){
          const response=await fetch('/admin/unblock-brand',{
            method:'post',
            headers:{
              'Content-Type':'application/json'
            },
            body:JSON.stringify({brandId})
          });

          const data=await response.json();
          if(data.success){
            Swal.fire({title:data.message,icon:"success",timer:5000,showConfirmButton:true})
            .then(()=>{
              location.reload()
            })
          }else{
            Swal.fire(data.message,"","error")
          }
        }
      }
    } catch (error) {
      console.log("error fetching:",error)
    }
  }
</script>