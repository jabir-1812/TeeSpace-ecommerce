<div class="container">
        <div class="row">
            <div class="col-6">
                <h3>Product Management</h1>
            </div>
            <div class="col-6">
                <div class="d-flex justify-content-end">
                    <a href="/admin/add-products"><button class="btn btn-success">Add New Product</button></a>
                </div>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-xl-6">
                <form action="/admin/products" method="get">
                    <div class="d-flex gap-3 align-items-center">
                        <input type="search" name="search" value="<%= search %>" placeholder="Search products..." class="form-control">
                        <button type="submit" class="btn btn-dark">Search</button>
                        <a href="/admin/products" class="btn btn-outline-dark">Clear</a>
                    </div>
                </form>
            </div>
        </div>

        <div class="row">
            <div class="col">
                <table class="table table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th scope="col">Product name</th>
                            <th scope="col">Brand</th>
                            <th scope="col">Category</th>
                            <th scope="col">Regular Price</th>
                            <th scope="col">Offers</th>
                            <th scope="col">Offer Actions</th>
                            <th scope="col">Sale Price</th>
                            <th scope="col">Quantity</th>
                            <th scope="col">Status</th>
                            <th scope="col">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                            <% if(product.length > 0) {%>
                                <% product.forEach((product,index)=>{ %>
                            <tr>
                                <td><%= product.productName %></td>
                                <td><%= product.brand?.brandName || "NA" %></td>
                                <td><%= product.category?.name || "NA" %></td>
                                <td><%= product.regularPrice %></td>
                                <td>
                                    <div>category offer:<%=product.categoryOffer%> %</div>
                                    <div>brand offer:<%=product.brandOffer%> %</div>
                                    <div>product offer:<%=product.productOffer%> %</div>
                                </td>
                                <td>
                                    <% if(product.productOffer===0){ %>
                                        <button class="btn btn-outline-primary" onclick="addOffer('<%= product._id %>')">Add Offer</button>
                                    <%}else{%>
                                        <button class="btn btn-outline-danger" onclick="removeOffer('<%= product._id %>')">Remove Offer</button>
                                    <% } %>
                                </td>
                                <td><%= product.salePrice.toFixed() %></td>
                                <td><%= product.quantity %></td>

                                <td id="status-<%= index %>"
                                    class="<%= product.isBlocked ? 'text-danger' : 'text-success' %>">
                                    <%= product.status %>
                                </td>
                                <td>
                                    <a href="/admin/edit-product/<%= product._id %>" class="edit-btn btn btn-outline-dark">Edit</a>
                                    <button type="button"
                                            class="<%= product.isBlocked ? 'btn btn-success' : 'btn btn-danger' %>"
                                            id="product-<%= product._id %>"
                                            data-product-id="<%= product._id %>"
                                            data-is-blocked="<%= product.isBlocked %>"
                                            onclick="toggleBlockProduct(this,'<%= index %>')">
                                            <%= product.isBlocked ? 'Unblock' : 'Block' %>

                                    </button>
                                </td>
                            </tr>
                            <% }) %>
                        <% }else{ %>
                            <tr>
                                <td colspan="8" style="text-align: center;">No products found</td>
                            </tr>
                            <% } %>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="row">
            <div class="col">
                <div class="d-flex justify-content-center">
                 <!-- pagination -->
                    <% if (totalPages> 1) { %>
                        <div class="">
                            <% if (currentPage> 1) { %>
                                <a href="/admin/products?page=<%= currentPage - 1 %>&search=<%= search %>" class="btn btn-outline-dark">Previous</a>
                            <% } %>

                            <% for(let i=1; i <=totalPages; i++) { %>
                                <a href="/admin/products?page=<%= i %>&search=<%= search %>"
                                    class="<%= currentPage === i ? 'btn btn-dark text-white' : 'btn btn-outline-dark' %>">
                                    <%= i %>
                                </a>
                            <% } %>

                            <% if (currentPage < totalPages) { %>
                                <a href="/admin/products?page=<%= currentPage + 1 %>&search=<%= search %>" class="btn btn-outline-dark">Next</a>
                            <% } %>
                        </div>
                        <% } %>
                </div>
            </div>
        </div>
    
    </div>

    <script>
        async function addOffer(productId) {
            const {value:percentage}=await Swal.fire({
                title:"Offer in percentage",
                input:"number",
                inputLabel:"Percentage",
                inputPlaceholder:"%",
                showCancelButton:true
            });

            if(percentage){
                try {
                    const response=await fetch('/admin/add-product-offer',{
                        method:'POST',
                        headers:{
                            'content-type':'application/json'
                        },
                        body:JSON.stringify({
                            percentage:percentage,
                            productId:productId
                        })
                    })

                    const responseJson=await response.json();
                    if(response.ok && responseJson.status===true){
                        Swal.fire({
                            title:"Offer Added",
                            html:`The offer has been added.<br><strong>${responseJson.message}</strong>`,
                            icon:"success",
                            timer:10000,
                            showConfirmButton:true
                        }).then(()=>{
                            location.reload();
                        })
                    }else{
                        Swal.fire("Failed",responseJson.message || "Adding offer failed","error");
                    }
                } catch (error) {
                    Swal.fire({
                        title:"Error",
                        text:"An error occured while adding the offer",
                        icon:"error",
                        timer:5000,
                        showConfirmButton:true
                    });

                    console.log('Error Adding offer:',error)
                }
            }
        }



  async function removeOffer(productId) {
            try {
                const result =await Swal.fire({
                    title:`Remove this offer?`,
                    icon:'warning',
                    showCancelButton:true,
                    confirmButtonText:'Yes',
                    cancelButtonText:'Cancel'
                })
                if(result.isConfirmed){
                    const response=await fetch('/admin/remove-product-offer',{
                        method:"POST",
                        headers:{
                        "content-type":"application/json"
                        },
                        body:JSON.stringify({
                            productId:productId
                        })
                    })

                    const responseJson=await response.json();

                    if(response.ok && responseJson.status===true){
                     await Swal.fire({
                        title:"Offer removed",
                        text:"The offer has been removed",
                        icon:"success",
                        timer:5000,
                        showConfirmButton:true
                        }).then(()=>{
                            location.reload();
                        })
                    }else{
                        Swal.fire("Failed",responseJson.message || "Removing offer failed","error");
                    }
                }
                
            } catch (error) {
                Swal.fire(
                    "Error",
                    "An error occured while removing the offer",
                    "error"
                );
                console.log("Error removing offer:",error)
            }
        }



        async function toggleBlockProduct(button,index) {
    try {
      const productId=button.dataset.productId;
      const isBlocked=button.dataset.isBlocked==='true';
      const action=isBlocked ? "Unblock" : "Block";

      if(action==="Block"){
        const result=await Swal.fire({
          title:`Are you sure you want to Block this product`,
          icon:'warning',
          showCancelButton:true,
          confirmButtonText:'Yes, Block this product',
          cancelButtonText:'Cancel'
        });

        if(result.isConfirmed){
          const response=await fetch('/admin/block-product',{
            method:'post',
            headers:{
              'Content-Type':'application/json'
            },
            body:JSON.stringify({productId})
          });

          const data=await response.json();
          
          if(data.success){
            await Swal.fire("Done",data.message,"success");
            location.reload()
          }
        }
      }


      if(action==="Unblock"){
        const result=await Swal.fire({
          title:`Are you sure you want to Unblock this product`,
          icon:'warning',
          showCancelButton:true,
          confirmButtonText:'Yes, Unblock this product',
          cancelButtonText:'Cancel'
        });

        if(result.isConfirmed){
          const response=await fetch('/admin/unblock-product',{
            method:'post',
            headers:{
              'Content-Type':'application/json'
            },
            body:JSON.stringify({productId})
          });

          const data=await response.json();
          if(data.success){
            await Swal.fire("Done",data.message,"success");
            location.reload();    
          }
        }
      }
    } catch (error) {
      console.log("error fetching:",error)
    }
  }
    </script>