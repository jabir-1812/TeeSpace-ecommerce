<div class="container">
    <div class="row my-3">
        <div class="col-md-6">
            <h3>Coupon Management</h3>
        </div>
        <div class="col-md-6 d-flex justify-content-end">
            <a href="/admin/coupons/add-new-coupon" class="btn btn-success">Add New Coupon</a>
        </div>
    </div>

    <div class="row mb-3">
        <div class="col-xl-6">
            <form action="">
                <div class="d-flex gap-3">
                    <input type="search" name="search" placeholder="Search by coupon code..." value="<%= search %>" class="form-control">
                    <button type="submit" class="btn btn-dark">Search</button>
                    <a href="/admin/coupons" class="btn btn-outline-dark">Clear</a>
                </div>
            </form>
        </div>
    </div>

    <div class="row">
        <div class="col">
            <table class="table table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>#</th>
                        <th>Coupon Code</th>
                        <th>Type</th>
                        <th>Discount</th>
                        <th>Min Purchase</th>
                        <th>Max Discount</th>
                        <th>Start Date</th>
                        <th>Expiry Date</th>
                        <th>Status</th>
                        <th>Actions</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <% coupons.forEach((coupon, index) => { %>
                    <tr>
                        <td><%= index + 1 %></td>
                        <td><strong><%= coupon.couponCode %></strong></td>
                        <td><%= coupon.discountType %></td>
                        <td>
                            <% if (coupon.discountType === 'percentage') { %>
                                <%= coupon.discountValue %>%
                            <% } else { %>
                                FLAT ₹<%= coupon.discountValue || "--" %>/-
                            <% } %>
                        </td>
                        <td>₹<%= coupon.minPurchase || 0 %></td>
                        <td>₹<%= coupon.maxDiscountAmount || "--" %></td>
                        <td><%= new Date(coupon.startDate).toLocaleDateString() %></td>
                        <td><%= new Date(coupon.expiryDate).toLocaleDateString() %></td>
                        <td class="<%= coupon.isActive ?'text-success' : 'text-danger' %>">
                            <%= coupon.isActive ? 'Active' : 'Inactive' %>
                        </td>
                        <td>
                            <% if(coupon.isActive){ %>
                                <button onclick="deActivateCoupon('<%= coupon._id %>','<%= coupon.couponCode %>')" class="btn btn-outline-danger">De-activate</button>
                                <% }else{ %>
                                    <button onclick="activateCoupon('<%= coupon._id %>','<%= coupon.couponCode %>')" class="btn btn-outline-success">Activate</button>
                                    <% } %>
                        </td>
                        <td>
                            <a href="/admin/coupons/edit-coupon/<%= coupon._id %>"><button class="btn btn-outline-dark">Edit</button></a>
                            <button onclick="deleteCoupon('<%= coupon._id %>','<%= coupon.couponCode %>')" class="btn btn-danger">Delete</button>
                            <script>
                                async function deleteCoupon(couponId,couponCode){
                                    const result=await Swal.fire({
                                        title:`Delete ${couponCode}?`,
                                        icon:'warning',
                                        showConfirmButton:true,
                                        confirmButtonText:"Delete",
                                        showCancelButton:true
                                    })
                                    if(result.isConfirmed){
                                        const response = await fetch(`/admin/coupons/delete-coupon/${couponId}`,{
                                            method:"DELETE",
                                        })

                                        const res=await response.json();
                                        if(res.success){
                                            Swal.fire({
                                                title:res.message,
                                                icon:"success",
                                                timer:5000,
                                                showConfirmButton:true
                                            }).then(()=>{
                                                location.reload()
                                            })
                                        }else{
                                            Swal.fire("OOPS",res.message,"error")
                                        }
                                    }
                                }

                                
                            </script>
                        </td>
                    </tr>
                    <% }) %>
                </tbody>
            </table>
        </div>
    </div>

    <div class="row">
        <div class="col">
            <div class="d-flex justify-content-center gap-2">
                <% if (currentPage > 1) { %>
                    <a href="?page=<%= currentPage - 1 %>&search=<%= search %>" class="btn btn-outline-dark">Previous</a>
                <% } %>

                <% for (let i = 1; i <= totalPages; i++) { %>
                    <a href="?page=<%= i %>&search=<%= search %>" class="btn <%= currentPage === i ? 'btn-dark' : 'btn-outline-dark' %>"><%= i %></a>
                <% } %>

                <% if (currentPage < totalPages) { %>
                    <a href="?page=<%= currentPage + 1 %>&search=<%= search %>" class="btn btn-outline-dark">Next</a>
                <% } %>
            </div>
        </div>
    </div>
</div>

<script>
    async function deActivateCoupon(couponId,couponCode) {
        const result = await Swal.fire({
            title:`De-activate ${couponCode} ?`,
            showCancelButton:true,
            showConfirmButton:true,
            confirmButtonText:"De-activate",
            icon:'question'
        })
        
        if(result.isConfirmed){
            const response=await fetch(`/admin/coupons/de-activate/${couponId}`,{
                method:'PUT',
            })
            
            const res=await response.json();
            if(res.success){
                Swal.fire({
                    title:res.message,
                    timer:5000,
                    showConfirmButton:true,
                    icon:'success'
                }).then(()=>{
                    location.reload();
                })
            }else{
                Swal.fire(res.message,"",'error')
            }
        }
    }
    async function activateCoupon(couponId,couponCode) {
        const result = await Swal.fire({
            title:`Activate ${couponCode} ?`,
            showCancelButton:true,
            showConfirmButton:true,
            confirmButtonText:"Activate",
            icon:'question'
        })
        
        if(result.isConfirmed){
            const response=await fetch(`/admin/coupons/activate/${couponId}`,{
                method:'PUT',
            })
            
            const res=await response.json();
            if(res.success){
                Swal.fire({
                    title:res.message,
                    timer:5000,
                    showConfirmButton:true,
                    icon:'success'
                }).then(()=>{
                    location.reload();
                })
            }else{
                Swal.fire(res.message,"",'error')
            }
        }
    }
</script>
<%-include ('../../../views/partials/admin/footer')%>