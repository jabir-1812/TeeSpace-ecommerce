<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">

<div class="container">
    <div class="row mb-3">
        <h3 class="text-center">Edit Banner</h3>
    </div>

    <form id="editBannerForm" action="/admin/edit-banner/<%= banner._id %>">
        <div class="row mb-3">
            <div class="col-sm-4">
                <label for="bannerTitle" class="fw-bold">Banner Title:</label>
                <input type="text" name="title" id="bannerTitle" class="form-control" value="<%= banner.title %>">
                <div id="bannerTitle-error" class="error-message text-danger"></div>
            </div>
            <div class="col-sm-8">
                <label for="description" class="fw-bold">Description:</label>
                <textarea name="description" id="description" class="form-control"><%= banner.description %></textarea>
                <div id="description-error" class="error-message text-danger"></div>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-sm-4">
                <label for="startDate" class="fw-bold">Start Date:</label>
                <input type="date" id="startDate" name="startDate" class="form-control" value="<%= banner.startDate.toISOString().split('T')[0] %>">
                <div id="startDate-error" class="error-message text-danger"></div>
            </div>

            <div class="col-sm-4">
                <label for="endDate" class="fw-bold">End Date:</label>
                <input type="date" id="endDate" name="endDate" class="form-control" value="<%= banner.endDate.toISOString().split('T')[0] %>">
                <div id="endDate-error" class="error-message text-danger"></div>
            </div>

            <div class="col-sm-4">
                <label for="bannerLink" class="fw-bold">Link:</label>
                <input type="text" name="link" id="bannerLink" class="form-control" value="<%= banner.link %>">
                <div id="bannerLink-error" class="error-message text-danger"></div>
            </div>
        </div>

        <!-- hidden input field to track removing of old image -->
        <input type="hidden" name="removeOldImage" id="removeOldImageInput" value="false">
        <div class="row justify-content-center">
            <div class="col-4 d-flex flex-column align-items-center" id="oldImageContainer">
                <span class="fw-bold">Current Banner Image:</span>
                <img class="img-thumbnail" src="<%= banner.image %>" alt="Current Banner Image">
                <button type="button" class="btn btn-outline-danger" id="removeOldImage">Remove</button>
            </div>
        </div>


        <div class="row justify-content-center">
            <div style="display: none;" id="newImageSection">
                <div class="col-9 d-flex flex-column align-items-center gap-2">
                    <input type="file" class="form-control" id="imageInput" accept="image/*">
                    <div id="bannerImage-error" class="error-message text-danger"></div>
                    <img id="image" width="300px" src="" alt="">
                    <button class="btn btn-success" type="button" id="cropButton" style="display: none;">Crop & Save</button>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-9" id="preview" style="display: none;">
                <img class="img-thumbnail" id="croppedPreview" />
                <button class="btn btn-outline-danger" type="button" id="removeImage">Remove</button>
            </div>
        </div>


        <div class="row my-3">
            <div class="col d-flex justify-content-center gap-5">
                <button class="btn btn-dark">Update Banner</button>
                <a href="/admin/banners" class="btn btn-outline-dark">Cancel</a>
            </div>            
        </div>
    </form>
</div>


<!-- Scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

<script>
    const form=document.getElementById('editBannerForm');
    //error div elements
    const errorElements=document.getElementsByClassName('error-message')
    const bannerTitleError=document.getElementById('bannerTitle-error');
    const descriptionError=document.getElementById('description-error');
    const startDateError=document.getElementById('startDate-error');
    const endDateError=document.getElementById('endDate-error');
    const bannerLinkError=document.getElementById('bannerLink-error');

    ////////////////////////////////////banner image error
    const bannerImageError=document.getElementById('bannerImage-error')

    let cropper;
    let croppedBlob = null; // ðŸ†• store the cropped image file
    const imageInput = document.getElementById('imageInput');//<input>
    const image = document.getElementById('image');//<img>
    const cropButton = document.getElementById('cropButton');
    const preview = document.getElementById('preview');
    const croppedPreview = document.getElementById('croppedPreview');
    const removeImage = document.getElementById('removeImage');
    // const successAlert = document.getElementById('successAlert');
    const newImageSection = document.getElementById('newImageSection');
    const oldImageContainer = document.getElementById('oldImageContainer');
    const removeOldImageInput = document.getElementById('removeOldImageInput');
    const removeOldImageBtn = document.getElementById('removeOldImage');

    if (removeOldImageBtn) {
        removeOldImageBtn.addEventListener('click', () => {
        oldImageContainer.innerHTML='';
        newImageSection.style.display = 'block';
        removeOldImageInput.value = 'true';
        document.getElementById('sample').style.display='none'
        });
    }

    imageInput.addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;
    preview.style.display='none'

    const reader = new FileReader();
    reader.onload = () => {
      image.src = reader.result;
      image.onload = () => {
        image.style.display = 'block';
        cropButton.style.display = 'inline';

        if (cropper) cropper.destroy();
        cropper = new Cropper(image, {
          aspectRatio: 16/9,
          viewMode: 1,
          autoCropArea: 1
        });
      };
    };
    reader.readAsDataURL(file);
  });

  cropButton.addEventListener('click', () => {
    if (!cropper) return;

    cropper.getCroppedCanvas({ width: 1920, height: 600 }).toBlob(blob => {
      croppedBlob = blob;

      const previewURL = URL.createObjectURL(blob);
      croppedPreview.src = previewURL;

      preview.style.display = 'block';
      image.style.display = 'none';
      cropButton.style.display = 'none';
      cropper.destroy();
    }, 'image/jpeg');
  });

  removeImage.addEventListener('click', () => {
    preview.style.display = 'none';
    croppedPreview.src = '';
    imageInput.value = '';
    croppedBlob = null;
    image.style.display = 'none';
  });



    //form validation
    form.addEventListener('submit',async (e)=>{
        e.preventDefault();

        //clearing error messages
        Array.from(errorElements).forEach(element=>{
            element.innerHTML='';
            element.style.display='none';
        });

        const bannerTitle=document.getElementById('bannerTitle').value;
        const description=document.getElementById('description').value;
        // const descriptionValue=description.value;
        const startDate=document.getElementById('startDate').value;
        const endDate=document.getElementById('endDate').value;
        const bannerLink=document.getElementById('bannerLink').value;

         if(bannerTitle.trim()===""){
            bannerTitleError.innerText="Banner title is required";
            bannerTitleError.style.display='block';
            return;
        }

        if(!/^[a-zA-Z0-9\s\-&]+$/.test(bannerTitle.trim())) {
            bannerTitleError.innerText = "Only letters, numbers, spaces, hyphens, and ampersands are allowed";
            bannerTitleError.style.display = 'block';
            return;
        }

        if(description.trim()===""){
            descriptionError.innerText='Description is required';
            descriptionError.style.display='block';
            return;
        }

        if(startDate===""){
            startDateError.innerText="This field is required"
            startDateError.style.display='block';
            return;
        }

        if(endDate===""){
            endDateError.innerText="This field is required";
            endDateError.style.display='block';
            return;
        }

        const startDateObj=new Date(startDate);
        const endDateObj=new Date(endDate);

        if(endDateObj<startDateObj){
            endDateError.innerText="Ending date should greater than Starting date";
            endDateError.style.display='block';
            return;
        }

        if(bannerLink.trim()===""){
            bannerLinkError.innerText="This feild is required";
            bannerLinkError.style.display="block";
            return;
        }

        const removeOld=removeOldImageInput.value==='true';
        if (removeOld && !croppedBlob) {
            bannerImageError.innerText="Please select and crop a new image";
            bannerImageError.style.display='block';
            // alert("Please select and crop a new image before submitting.");
            return;
        }

        const formData=new FormData(form)
        if(croppedBlob){
            formData.append('image',croppedBlob,'cropped.jpg')
        }

        for (let pair of formData.entries()) {           
            console.log(pair[0] + ':', pair[1]);
        }
        try {
            const response = await fetch(form.action, {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (response.ok) {
                Swal.fire({
                    title: 'Success!',
                    text: "Banner added successfully",
                    icon: 'success',
                    timer: 1500,
                    showConfirmButton: false
                }).then(() => {
                    window.location.href = "/admin/banners";
                });
            } else {
                Swal.fire({
                    title: "Error!",
                    text: result.message || "Failed to add banner",
                    icon: "error"
                });
            }
        } catch (error) {
            Swal.fire({
                title: "Error!",
                text: "An unexpected error occurred",
                icon: "error"
            });
            console.error("Error:", error);
        }

        
    })
</script>