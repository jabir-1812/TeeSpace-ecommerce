<%-include ('../../../../views/partials/user/header')%>

<%-include ('../../../../views/user/profile/profile-partials/sidebar')%>

<style>
    /* Main Container */
    .main-content {
        margin-left: 220px; /* sidebar width */
        padding: 90px 30px 30px;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%);
        min-height: 100vh;
    }

    /* Order Details Card */
    .order-details {
        max-width: 1000px;
        margin: 0 auto;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        padding: 30px;
    }

    .order-details h2 {
        color: #2c3e50;
        font-size: 28px;
        margin-bottom: 25px;
        border-bottom: 3px solid #3498db;
        padding-bottom: 10px;
    }

    .order-details h3 {
        color: #34495e;
        font-size: 20px;
        margin-top: 30px;
        margin-bottom: 15px;
        font-weight: 600;
    }

    /* Order Summary Box */
    .order-summary {
        background: #f8f9fa;
        border-left: 4px solid #3498db;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 25px;
    }

    .order-summary p {
        margin: 10px 0;
        font-size: 16px;
        color: #555;
    }

    .order-summary strong {
        color: #2c3e50;
        font-weight: 600;
    }

    /* Status Colors */
    .text-danger { color: #e74c3c !important; font-weight: 600; }
    .text-success { color: #27ae60 !important; font-weight: 600; }
    .text-primary { color: #3498db !important; font-weight: 600; }
    .text-info { color: #17a2b8 !important; font-weight: 600; }
    .text-warning { color: #f39c12 !important; font-weight: 600; }

    /* Shipping Address */
    .shipping-address {
        background: #fff9e6;
        border: 2px solid #f39c12;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
    }

    .shipping-address p {
        margin: 8px 0;
        color: #555;
        font-size: 15px;
    }

    /* Order Items */
    .order-items {
        margin-top: 20px;
    }

    .item {
        display: flex;
        gap: 20px;
        background: white;
        border: 2px solid #ecf0f1;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        transition: all 0.3s ease;
    }

    .item:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        transform: translateY(-2px);
    }

    .item img {
        width: 120px;
        height: 120px;
        object-fit: cover;
        border-radius: 8px;
        border: 2px solid #ecf0f1;
    }

    .item-info {
        flex: 1;
    }

    .item-info h4 {
        color: #2c3e50;
        font-size: 18px;
        margin-bottom: 10px;
        font-weight: 600;
    }

    .item-info p {
        margin: 8px 0;
        color: #666;
        font-size: 14px;
    }

    /* Buttons */
    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-block;
        margin-top: 10px;
        margin-right: 10px;
    }

    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .btn-primary {
        background: #3498db;
        color: white;
    }

    .btn-primary:hover {
        background: #2980b9;
    }

    .btn-danger {
        background: #e74c3c;
        color: white;
    }

    .btn-danger:hover {
        background: #c0392b;
    }

    .btn-warning {
        background: #f39c12;
        color: white;
    }

    .btn-warning:hover {
        background: #e67e22;
    }

    /* Forms */
    .cancel-form, .return-form, #cancelOrderForm {
        display: inline-block;
        margin-top: 10px;
    }

    #cancelOrderForm {
        margin-top: 30px;
        text-align: center;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .main-content {
            margin-left: 0;
            padding: 20px 15px;
        }

        .order-details {
            padding: 20px;
        }

        .item {
            flex-direction: column;
        }

        .item img {
            width: 100%;
            height: 200px;
        }
    }

    /* Price Highlight */
    .order-summary p:last-child {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px;
        border-radius: 8px;
        margin-top: 15px;
        text-align: center;
    }

    /* Invoice Button Special Style */
    .btn-primary[href*="invoice"] {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 12px 24px;
        font-size: 15px;
        margin-top: 20px;
        margin-bottom: 20px;
    }
</style>
<% console.log("isCouponApplied==============",order.isCouponApplied) %>

<div class="main-content">
    <div class="order-details">
        <h2>üì¶ Order Details</h2>

        <div class="order-summary">
            <p><strong>Order ID:</strong> <%= order.orderId %></p>
            <p>
                <strong>Status:</strong> 
                <span class="<%= 
                    order.orderStatus === 'Cancelled' ? 'text-danger' :
                    order.orderStatus === 'Payment Failed' ? 'text-danger' : 
                    order.orderStatus === 'Delivered' ? 'text-success' : 
                    order.orderStatus === 'Shipped' ? 'text-primary' : 
                    order.orderStatus === 'Out for Delivery' ? 'text-info' : 
                    order.orderStatus === 'Pending' ? 'text-warning' : 
                    '' 
                %>">
                    <%= order.orderStatus %>
                </span>
                <% if(order.orderStatus==="Delivered"){ %>
                    - On <%= new Date(order.deliveredOn).toDateString().slice(4) %>
                <%}%>
            </p>

            <p><strong>Placed on:</strong> <%= new Date(order.createdAt).toDateString() %></p>
            <p><strong>Payment:</strong> <%= order.paymentMethod %> ( <%= order.paymentStatus %> )</p>
            <% if(order.refundStatus==="Refunded" || order.refundStatus==="Refunded to your wallet"){ %>
            <p><strong>Refund Status:</strong> <%= order.refundStatus %></p>
            <% } %>
            <p><strong style="color: white;">Total:</strong><strong style="font-size: x-large; color: white;">‚Çπ<%= order.totalAmount.toFixed(2) %>/-</strong></p>
        </div>

        <h3>üìç Shipping Address</h3>
        <div class="shipping-address">
            <p><strong><%= order.shippingAddress.name %></strong></p>
            <p><%= order.shippingAddress.landMark %>, <%= order.shippingAddress.city %></p>
            <p><%= order.shippingAddress.state %> - <%= order.shippingAddress.pincode %></p>
            <p>üìû Phone: <%= order.shippingAddress.phone %></p>
        </div>
        
        <% if (order.invoice && order.invoice.generated) { %>
        <a href="/orders/<%= order._id %>/invoice" class="btn btn-primary">
            üìÑ Download Invoice
        </a>
        <% } %>


        <h3>üõçÔ∏è Items</h3>
        <div class="order-items">
            <% order.orderItems.forEach(item => { %>
                <div class="item">
                <img src="<%= item.productImage %>" alt="<%= item.productName %>">
                <div class="item-info">
                    <h4><%= item.productName %></h4>
                    <p class="fw-bold"><strong>‚Çπ<%= item.price.toFixed(2) %>/-</strong></p>
                    <p class="text-body-tertiary"><strong>Total Price:</strong> Rs.<%= item.totalSalePrice %>/- | <strong>Quantity:</strong><%= item.quantity %></p>
                    <p class="text-body-tertiary fw-bold">Rs.<%= item.salePrice %>/- per item</p>
                    <% if(item.couponDiscount){ %>
                        <p><strong>Coupon Discount:</strong><span  class="text-success">Rs.<%= item.couponDiscount %>/-</span></p>
                    <% } %>
                    <p>
                        <strong>Delivery Status:</strong>
                        <span class="<%= 
                            item.itemStatus === 'Cancelled' ? 'text-danger' :
                            item.itemStatus === 'Payment Failed' ? 'text-danger' : 
                            item.itemStatus === 'Delivered' ? 'text-success' : 
                            item.itemStatus === 'Shipped' ? 'text-primary' : 
                            item.itemStatus === 'Out for Delivery' ? 'text-info' : 
                            item.itemStatus === 'Pending' ? 'text-warning' : 
                            '' 
                        %>">
                            <%= item.itemStatus %>
                        </span>
                        <% if(item.itemStatus==="Delivered"){ %>
                           - On <%= new Date(item.deliveredOn).toDateString().slice(4) %>
                        <%}%>
                    </p>

                        <% if (item.returnStatus && item.returnStatus !== "None") { %>
                    <p>
                            <strong>Return Status:</strong>
                            <span class="<%= 
                                item.returnStatus === 'Requested' ? 'text-warning' : 
                                item.returnStatus === 'Approved' ? 'text-info' : 
                                item.returnStatus === 'Rejected' ? 'text-danger' : 
                                item.returnStatus === 'Completed' ? 'text-success' : 
                                '' 
                            %>">
                            <%= item.returnStatus %>
                            </span>
                    </p>
                    <p><strong>Return Reason:</strong> <%= item.returnReason %></p>
                            <% if(item.returnStatus === "Rejected"){ %>
                                <p><strong>Rejection Reason:</strong> <%= item.rejectionReason %></p>       
                            <% } %>
                        <% } %>

                        <% if(item.refundStatus){ %>
                        <p><strong>Refund Status:</strong> <%= item.refundStatus %></p>
                        <p><strong>Refunded On:</strong> <%= new Date(item.refundedOn).toDateString().slice(4) %></p>
                        <% } %>

                    <% if (item.itemStatus === "Pending") { %>
                       <form class="cancel-form">
                            <input type="hidden" name="orderId" value="<%= order.orderId %>">
                            <input type="hidden" name="itemId" value="<%= item._id %>">
                            <button type="submit" class="btn btn-danger">‚ùå Cancel Item</button>
                        </form>
                    <% } %>

                   <% if (item.itemStatus === "Delivered" && (!item.returnStatus || item.returnStatus === "None")) { %>
                    <form class="return-form">
                        <input type="hidden" name="orderId" value="<%= order.orderId %>">
                        <input type="hidden" name="itemId" value="<%= item._id %>">
                        <button type="submit" class="btn btn-warning">‚Ü©Ô∏è Return Item</button>
                    </form>
                    <% } %>
                </div>
                </div>
            <% }) %>
            </div>

            <%
                const hasRestrictedStatus = order.orderItems.some(
                    item => ["Shipped", "Delivered", "Out for Delivery"].includes(item.itemStatus)
                );
            %>

            <% if (!hasRestrictedStatus && (order.orderStatus === "Pending" || order.orderStatus === "Partially Cancelled")) { %>
            <form id="cancelOrderForm">
                <input type="hidden" name="orderId" value="<%= order.orderId %>">
                <button type="submit" class="btn btn-danger">‚ùå Cancel Entire Order</button>
            </form>
            <% } %>


            <!-- retry payment option -->
             <% if(order.orderStatus === "Payment Failed"){ %>
                <%
                    const createdAt = new Date(order.createdAt);
                    const sevenDaysAfter = new Date(createdAt.getTime() + 7 * 24 * 60 * 60 * 1000);
                    const now = new Date();
                    const showButton = now <= sevenDaysAfter;
                %>
                 <% if (showButton) { %>
                    <button class="btn btn-info" onclick="retryPayment('<%= order.orderId %>')">Retry Payment</button>
                <% } %>
            <% } %>

            <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
            <script>
                async function retryPayment(orderId='<%=order.orderId %>') {
                    try {

                        const confirm=await Swal.fire({
                            text:"Note : Price or discount may change",
                            icon:"warning",
                            showCancelButton:true,
                            showConfirmButton:true,
                            confirmButtonText:"Proceed"
                        })

                        if(!confirm.isConfirmed){
                            console.log("hahahah")
                            return;
                        }
                        console.log("confirm ==== ",confirm)
                        // Step 1: Create Razorpay order on your server
                        const response=await fetch('/order-details/retry-order',{
                            method:"PATCH",
                            headers:{"Content-Type":"application/json"},
                            body:JSON.stringify({orderId:orderId})
                        })

                        const razorpayOrder = await response.json()

                        if(!razorpayOrder || !razorpayOrder.razorpayOrder){
                            console.log("razorPayyyyyyyy",razorpayOrder)
                            console.log("razorPayyyyyyyy",razorpayOrder.razorpayOrder)

                            return Swal.fire({
                                title:"Failed to create order. Please try again.",
                                text:razorpayOrder.message, 
                                icon:"error",
                                showConfirmButton:true,
                            }).then(()=>{
                                location.reload();
                            })
                        }

                        //step 2: Configure Razorpay checkout
                        const options={
                            key:'<%= razorPayKeyId %>',
                            amount:razorpayOrder.razorpayOrder.amount,
                            currency:"INR",
                            name:"TeeSpace",
                            description:"Test Transaction",
                            order_id:razorpayOrder.razorpayOrder.id,
                            handler:async function(response){
                                try {
                                    // Step 3: Verify payment with your backend
                                    const verifyRes=await fetch('/verify-razorpay-payment',{
                                        method:"POST",
                                        headers:{"Content-Type":"application/json"},
                                        body:JSON.stringify({
                                            ...response,  // contains razorpay_payment_id, razorpay_order_id, razorpay_signature
                                            teeSpaceOrderId:razorpayOrder.teeSpaceOrderId, //add your internal order ID
                                            clearCart:false
                                        })
                                    })

                                    const result =await verifyRes.json();
                                    
                                    // Step 4: Handle response
                                    if (result.success) {
                                    await Swal.fire({
                                        title: "Payment verified successfully!",
                                        icon: "success",
                                        timer: 2000,
                                        showConfirmButton: false
                                    });

                                    await Swal.fire({
                                        title: "Order placed successfully!",
                                        icon: "success",
                                        timer: 2000,
                                        showConfirmButton: false
                                    });

                                    // Redirect to order success page
                                    window.location.href = `/order-success/${razorpayOrder.teeSpaceOrderId}`;
                                    } else {
                                        Swal.fire("Verification Failed", result.message || "Something went wrong.", "error")
                                    }

                                } catch (error) {
                                    console.error("Error verifying payment:", err);
                                    Swal.fire("Error", "Payment verification failed. Please contact support.", "error");
                                }
                            },
                            theme: { color: "#3399cc" }
                        }

                        // Step 5: Open Razorpay checkout
                        const rzp1 = new Razorpay(options);

                        rzp1.on("payment.failed",function(response){
                            Swal.fire({
                                title:"Payment Failed!",
                                text:response.error.description,
                                icon:"error",
                                showConfirmButton:true,
                                timer:25000
                            }).then(async()=>{
                                const res=await fetch('/razorpay/payment-failure',{
                                    method:"POST",
                                    headers:{
                                        "Content-Type":"application/json"
                                    },
                                    body:JSON.stringify({
                                        razorpay_order_id:response.error.metadata.order_id,
                                        razorpay_payment_id:response.error.metadata.payment_id,
                                        error_reason:response.error.description,
                                        appOrderId:razorpayOrder.teeSpaceOrderId
                                    })
                                })

                                const result=await res.json()
                                if(result.success){
                                    window.location.href = `/razorpay/order-failure/${razorpayOrder.teeSpaceOrderId}?accessToCheckoutPage=${false}`
                                }
                            })
                        })
                        rzp1.open();

                    } catch (error) {
                        console.error("Error creating Razorpay order:", error);
                        Swal.fire("Error", "Unable to start payment. Please try again later.", "error");
                    }
                }
            </script>
    </div>
</div>


<script>
    // document.querySelectorAll(".cancel-form").forEach(form => {
    //     form.addEventListener("submit", async (e) => {
    //             e.preventDefault();

    //             const confirmResult=await Swal.fire({
    //                 title:"Are you sure, Cancel this order?",
    //                 icon:'question',
    //                 showConfirmButton:true,
    //                 showCancelButton:true
    //             })

    //             if (!confirmResult.isConfirmed) return;

    //             const formData = new FormData(form);
    //             const data = Object.fromEntries(formData.entries());

    //             const response = await fetch("/user-profile/orders/order-details/cancel-item", {
    //             method: "POST",
    //             headers: { "Content-Type": "application/json" },
    //             body: JSON.stringify(data)
    //             });

    //             const result = await response.json();
    //             console.log("result=====>",result)
    //             if (result.success) {
    //                 Swal.fire({
    //                     title:"Done",
    //                     text:result.message,
    //                     icon:"success",
    //                     timer:2000
    //                 })
    //                 .then(()=>{
    //                     location.reload();
    //                 })
    //             } else {
    //             Swal.fire("Oops!",result.message,"error")
    //             }
    //         });
    //     });


        document.querySelectorAll(".cancel-form").forEach(form => {
        form.addEventListener("submit", async (e) => {
                e.preventDefault();

                if(<%=order.isCouponApplied %>){
                    const warning=await Swal.fire({
                        title:"You may lose your coupon discounts!",
                        text:"Since this order includes a coupon discount, cancelling or returning it may result in losing the discount benefits. Please confirm before proceeding",
                        icon:"warning",
                        showCancelButton:true,
                        confirmButtonText:"Proceed"
                    })

                    if(!warning.isConfirmed){
                        return;
                    }
                }
                

                const confirmResult=await Swal.fire({
                    title:"Are you sure, Cancel this order?",
                    icon:'question',
                    showConfirmButton:true,
                    showCancelButton:true
                })

                if (!confirmResult.isConfirmed) return;

                let confirmReason=await Swal.fire({
                    title:"Why are you canceling this order ?",
                    input:"select",
                    inputOptions:{
                        "Ordered the wrong item":"Ordered the wrong item",
                        "Found a better price elsewhere":"Found a better price elsewhere",
                        "Product no longer needed":"Product no longer needed",
                        "Changed my mind about the purchase":"Changed my mind about the purchase",
                        "Quantity or size was incorrect":"Quantity or size was incorrect",
                        "other":"other"
                    },
                    inputPlaceholder:"Select a reason",
                    showCancelButton:true,
                    inputValidator:(value)=>{
                        if(!value){
                            return "‚ö†Ô∏è Please select a reason before continuing!";
                        }
                    }
                });

                if(!confirmReason.isConfirmed) return;
                let reason=confirmReason.value;

                if(reason==="other"){
                    const customReason = await Swal.fire({
                        title:"Please specify your reason",
                        input:"textarea",
                        inputPlaceholder:"Type your reason here...",
                        inputAttributes:{'aria-label':'Cancellation reason'},
                        showCancelButton:true,
                        inputValidator:(value)=>{
                            if(!value.trim()){
                                return "‚ö†Ô∏è Please enter a reason"
                            }
                        }
                    })
                    if(!customReason.isConfirmed) return;
                    reason=customReason.value;
                }

                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());
                data.reason=reason;

                const response = await fetch("/user-profile/orders/order-details/cancel-item", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
                });

                const result = await response.json();
                console.log("result=====>",result)
                if (result.success) {
                    Swal.fire({
                        title:"Done",
                        text:result.message,
                        icon:"success",
                        timer:2000
                    })
                    .then(()=>{
                        location.reload();
                    })
                } else {
                Swal.fire("Oops!",result.message,"error")
                }
            });
        });
</script>

<script>
    const cancelOrderForm=document.getElementById('cancelOrderForm');
    if(cancelOrderForm){
        cancelOrderForm.addEventListener('submit',async (e)=>{
            e.preventDefault()
            if(<%=order.isCouponApplied %>){
                const warning=await Swal.fire({
                    title:"You may lose your coupon discounts!",
                    text:"Since this order includes a coupon discount, cancelling or returning whole order may result in losing the discount benefits. Please confirm before proceeding",
                    icon:"warning",
                    showCancelButton:true,
                    confirmButtonText:"Proceed"
                })

                if(!warning.isConfirmed){
                    return;
                }
            }
            // console.log("form prevented")
            const confirmResult=await Swal.fire({
                title:"Are you sure, Cancel Whole order ?",
                showConfirmButton:true,
                showCancelButton:true,
                icon:"question"
            })

            if(!confirmResult.isConfirmed) return;

            let confirmReason=await Swal.fire({
                title:"Why are you canceling this order ?",
                input:"select",
                inputOptions:{
                    "Ordered the wrong item":"Ordered the wrong item",
                    "Found a better price elsewhere":"Found a better price elsewhere",
                    "Product no longer needed":"Product no longer needed",
                    "Changed my mind about the purchase":"Changed my mind about the purchase",
                    "Quantity or size was incorrect":"Quantity or size was incorrect",
                    "other":"other"
                },
                inputPlaceholder:"Select a reason",
                showCancelButton:true,
                inputValidator:(value)=>{
                    if(!value){
                        return "‚ö†Ô∏è Please select a reason before continuing!";
                    }
                }
            });

            if(!confirmReason.isConfirmed) return;
            let reason=confirmReason.value;

            if(reason==="other"){
                const customReason = await Swal.fire({
                    title:"Please specify your reason",
                    input:"textarea",
                    inputPlaceholder:"Type your reason here...",
                    inputAttributes:{'aria-label':'Cancellation reason'},
                    showCancelButton:true,
                    inputValidator:(value)=>{
                        if(!value.trim()){
                            return "‚ö†Ô∏è Please enter a reason"
                        }
                    }
                })
                if(!customReason.isConfirmed) return;
                reason=customReason.value;
            }

            const formData=new FormData(cancelOrderForm);
            const data=Object.fromEntries(formData.entries());

            const response=await fetch("/user-profile/orders/order-details/cancel-orders",{
                method:'post',
                headers:{
                    'Content-Type':'application/json'
                },
                body:JSON.stringify(data)
            })

            const result=await response.json();
            if(result.success){
                Swal.fire({
                    title:"Done",
                    text:result.message,
                    icon:'success',
                    timer:2000
                }).then(()=>{
                    location.reload();
                })
            }else{
                Swal.fire("Oops!",result.message,"error")
            }
        })
    }
</script>

<script>
    document.querySelectorAll(".return-form").forEach(form => {
        form.addEventListener("submit", async (e) => {
            e.preventDefault();

            if(<%=order.isCouponApplied %>){
                const warning=await Swal.fire({
                    title:"You may lose your coupon discounts!",
                    text:"Since this order includes a coupon discount, cancelling or returning it may result in losing the discount benefits. Please confirm before proceeding",
                    icon:"warning",
                    showCancelButton:true,
                    confirmButtonText:"Proceed"
                })

                if(!warning.isConfirmed){
                    return;
                }
            }

            const confirmResult = await Swal.fire({
                title: "Why are you returning this item?",
                input: "select",
                inputOptions: {
                    "Wrong item received": "Wrong item received",
                    "damaged product": "Damaged product",
                    "defective": "Defective",
                    "quality not as expected": "Quality not as expected",
                    "size/fit issue": "Size/fit issue",
                    "changed my mind": "Changed my mind",
                    "other": "Other"
                },
                inputPlaceholder: "Select a reason",
                showCancelButton: true,
                inputValidator: (value) => {
                    if (!value) {
                        return "‚ö†Ô∏è Please select a reason before continuing!";
                    }
                }
            });
            if(!confirmResult.isConfirmed) return;

            let reason = confirmResult.value;

            if (reason === "other") {
                const customReason = await Swal.fire({
                    title: "Please specify your reason",
                    input: "textarea",
                    inputPlaceholder: "Type your reason here...",
                    inputAttributes: { 'aria-label': 'Return reason' },
                    showCancelButton: true,
                    inputValidator: (value) => {
                        if (!value.trim()) {
                            return "‚ö†Ô∏è Please enter a reason!";
                        }
                    }
                });

                if (!customReason.isConfirmed) return; // user cancelled
                reason = customReason.value; // use custom input as reason
            }



            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            data.reason = reason; // either predefined or custom

            const response = await fetch("/user-profile/orders/order-details/return-item", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (result.success) {
                Swal.fire({
                    title: "Return requested",
                    text: result.message,
                    icon: "success",
                    timer: 2000
                }).then(() => location.reload());
            } else {
                Swal.fire("Oops!", result.message, "error");
            }
        });
    });
    </script>

<%-include ('../../../../views/partials/user/footer')%>
